<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PayvoraX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: pan-x pan-y;
            /* Disables double-tap zoom */
        }

        .nu-purple {
            background-color: #820AD1;
        }

        .nu-purple-dark {
            background-color: #6D08AF;
        }

        .nu-text-purple {
            color: #820AD1;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            transition: all 0.2s;
        }

        .privacy-hidden {
            color: #000 !important;
            letter-spacing: 2px;
            font-family: monospace;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        ::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        html,
        body {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* --- Optimistic UI: instant feedback layer --- */
        .pvx-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(255, 255, 255, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
        }

        .pvx-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .pvx-spinner {
            width: 36px;
            height: 36px;
            border: 3px solid #e5e7eb;
            border-top-color: #820AD1;
            border-radius: 50%;
            animation: pvx-spin 0.6s linear infinite;
        }

        @keyframes pvx-spin {
            to {
                transform: rotate(360deg);
            }
        }

        .pvx-overlay-msg {
            margin-top: 12px;
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        /* Skeleton shimmer for data loading */
        .pvx-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: pvx-shimmer 1.2s infinite;
            border-radius: 6px;
            min-height: 1.2em;
        }

        @keyframes pvx-shimmer {
            0% {
                background-position: 200% 0
            }

            100% {
                background-position: -200% 0
            }
        }

        /* Toast notification */
        .pvx-toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
        }

        .pvx-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-8px);
        }

        .pvx-toast.success {
            background: #065f46;
            color: white;
        }

        .pvx-toast.error {
            background: #991b1b;
            color: white;
        }

        .pvx-toast.info {
            background: #1e40af;
            color: white;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Optimistic UI: full-screen loading overlay -->
    <div id="pvx-overlay" class="pvx-overlay">
        <div class="pvx-spinner"></div>
        <p class="pvx-overlay-msg" id="pvx-overlay-msg">Processando...</p>
    </div>
    <!-- Toast notifications -->
    <div id="pvx-toast" class="pvx-toast"></div>

    <!-- Mobile-first Header -->
    <header class="nu-purple text-white p-4 shadow-lg">
        <div class="w-full max-w-md md:max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="/static/img/logo.png" alt="Logo" class="w-16 h-16 rounded-full object-cover shadow-md">
                <span class="font-semibold text-lg" id="user-greeting">Olá, {{ user_name.split(' ')[0] if user_name else
                    'Cliente' }}</span>
            </div>
            <div class="flex gap-4">
                <i data-lucide="eye" id="toggle-balance"
                    class="w-6 h-6 cursor-pointer hover:text-gray-200 transition-colors"></i>
                <i data-lucide="help-circle" class="w-6 h-6 cursor-pointer hover:text-gray-200"></i>
                <i data-lucide="log-out" onclick="logout()" class="w-6 h-6 cursor-pointer hover:text-gray-200"></i>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow w-full max-w-md md:max-w-6xl mx-auto p-4 space-y-6">
        {% block content %}{% endblock %}
    </main>

    <!-- Bottom Navigation (App Style) -->
    <nav class="bg-white border-t border-gray-200 sticky bottom-0 pb-4 pt-2 px-6 z-50">
        <div
            class="w-full max-w-md md:max-w-6xl mx-auto flex justify-between items-center text-gray-500 text-xs font-medium">
            <a href="/"
                class="flex flex-col items-center gap-1 hover:text-purple-700 {{ 'text-purple-700' if page == 'home' else '' }}">
                <i data-lucide="arrow-up-down" class="w-6 h-6"></i>
                <span>Transações</span>
            </a>
            <a href="/ui/pix"
                class="flex flex-col items-center gap-1 hover:text-purple-700 {{ 'text-purple-700' if page == 'pix' else '' }}">
                <i data-lucide="zap" class="w-6 h-6"></i>
                <span>Área Pix</span>
            </a>
            <a href="/ui/extrato"
                class="flex flex-col items-center gap-1 hover:text-purple-700 {{ 'text-purple-700' if page == 'extrato' else '' }}">
                <i data-lucide="list" class="w-6 h-6"></i>
                <span>Extrato</span>
            </a>
            <a href="/ui/boleto"
                class="flex flex-col items-center gap-1 hover:text-purple-700 {{ 'text-purple-700' if page == 'boleto' else '' }}">
                <i data-lucide="barcode" class="w-6 h-6"></i>
                <span>Pagar</span>
            </a>
        </div>
    </nav>

    <script>
        lucide.createIcons();

        // --- ZOOM PREVENTION LOGIC ---
        // 1. Prevent Ctrl + Scroll (Desktop Zoom)
        document.addEventListener('wheel', function (e) {
            if (e.ctrlKey) {
                e.preventDefault();
            }
        }, { passive: false });

        // 2. Prevent Ctrl + +/- Keys (Desktop Zoom)
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && (
                e.key === '+' ||
                e.key === '-' ||
                e.key === '=' ||
                e.key === '0'
            )) {
                e.preventDefault();
            }
        });

        // 3. Prevent Pinch Zoom (Mobile/Tablet)
        document.addEventListener('touchmove', function (e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        // 4. Prevent Double Tap Zoom (Mobile/Tablet)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (e) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        // -----------------------------

        // Balance Toggle Logic
        const toggleBtn = document.getElementById('toggle-balance');
        let isBalanceVisible = localStorage.getItem('balanceVisible') !== 'false'; // Default true

        function updateBalanceVisibility() {
            const sensitiveElements = document.querySelectorAll('.sensitive-data');

            sensitiveElements.forEach(el => {
                if (!el.dataset.original) {
                    el.dataset.original = el.innerText;
                }

                if (isBalanceVisible) {
                    el.innerText = el.dataset.original;
                    el.classList.remove('privacy-hidden');
                } else {
                    el.innerText = '******';
                    el.classList.add('privacy-hidden');
                }
            });

            if (toggleBtn) {
                if (isBalanceVisible) {
                    toggleBtn.setAttribute('data-lucide', 'eye');
                    toggleBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye w-6 h-6 cursor-pointer hover:text-gray-200 transition-colors"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>';
                } else {
                    toggleBtn.setAttribute('data-lucide', 'eye-off');
                    toggleBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off w-6 h-6 cursor-pointer hover:text-gray-200 transition-colors"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>';
                }
            }
        }

        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                isBalanceVisible = !isBalanceVisible;
                localStorage.setItem('balanceVisible', isBalanceVisible);
                updateBalanceVisibility();
            });
        }

        // Run on load
        // Wait for DOM content to be loaded to ensure elements are present
        document.addEventListener('DOMContentLoaded', updateBalanceVisibility);

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            localStorage.removeItem('user_name');
            window.location.href = '/login';
        }

        // === Optimistic UI Engine ===
        const PVX = {
            overlay: document.getElementById('pvx-overlay'),
            overlayMsg: document.getElementById('pvx-overlay-msg'),
            toastEl: document.getElementById('pvx-toast'),
            _toastTimer: null,

            /** Show full-screen loading overlay with instant feedback */
            showOverlay(msg = 'Processando...') {
                this.overlayMsg.textContent = msg;
                this.overlay.classList.add('active');
            },

            /** Hide overlay */
            hideOverlay() {
                this.overlay.classList.remove('active');
            },

            /** Show a toast notification (success | error | info) */
            showToast(msg, type = 'success', duration = 3000) {
                clearTimeout(this._toastTimer);
                this.toastEl.textContent = msg;
                this.toastEl.className = `pvx-toast ${type} show`;
                this._toastTimer = setTimeout(() => {
                    this.toastEl.classList.remove('show');
                }, duration);
            },

            /**
             * Optimistic fetch: shows overlay instantly, executes request,
             * then shows toast with result. Returns the response.
             */
            async optimisticFetch(url, options = {}, optimisticMsg = 'Processando...') {
                this.showOverlay(optimisticMsg);
                try {
                    const response = await fetch(url, options);
                    this.hideOverlay();
                    return response;
                } catch (err) {
                    this.hideOverlay();
                    this.showToast('Erro de conexao. Tente novamente.', 'error');
                    throw err;
                }
            }
        };

        // Database warm-up: silent health-check to wake Neon compute on page load.
        // This runs in the background so by the time the user interacts,
        // the database connection is already established (~500ms head start).
        (function warmUpDatabase() {
            fetch('/health', { method: 'GET', priority: 'low' }).catch(() => { });
        })();
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>
