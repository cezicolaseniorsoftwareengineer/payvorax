{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Extrato</h1>
    <p class="text-gray-500">Histórico completo de suas transações.</p>
</div>

<!-- Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <p class="text-sm text-gray-500 mb-1">Saldo Atual</p>
        <h3 class="text-2xl font-bold text-gray-900" id="saldo-atual">R$ ...</h3>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <p class="text-sm text-gray-500 mb-1">Total Entradas</p>
        <h3 class="text-2xl font-bold text-green-600" id="total-entradas">R$ ...</h3>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <p class="text-sm text-gray-500 mb-1">Total Saídas</p>
        <h3 class="text-2xl font-bold text-red-600" id="total-saidas">R$ ...</h3>
    </div>
</div>

<!-- Filters -->
<div class="flex gap-2 mb-4 overflow-x-auto pb-2">
    <button onclick="filterExtrato('todos')"
        class="px-4 py-2 bg-gray-900 text-white rounded-lg text-sm font-medium whitespace-nowrap">Todos</button>
    <button onclick="filterExtrato('CREATED')"
        class="px-4 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg text-sm font-medium whitespace-nowrap hover:bg-gray-50">Pendentes</button>
    <button onclick="filterExtrato('CONFIRMED')"
        class="px-4 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg text-sm font-medium whitespace-nowrap hover:bg-gray-50">Confirmados</button>
    <button onclick="filterExtrato('SCHEDULED')"
        class="px-4 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg text-sm font-medium whitespace-nowrap hover:bg-gray-50">Agendados</button>
</div>

<!-- Transactions List (Desktop) -->
<div class="hidden md:block bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-50 border-b border-gray-100">
                    <th class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Data</th>
                    <th class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Descrição</th>
                    <th class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right">Valor</th>
                </tr>
            </thead>
            <tbody id="extrato-body" class="divide-y divide-gray-100">
                <!-- Rows will be populated by JS -->
                <tr>
                    <td colspan="4" class="p-8 text-center text-gray-500">Carregando transações...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Transactions List (Mobile) -->
<div id="extrato-mobile" class="md:hidden space-y-3">
    <!-- Cards will be populated by JS -->
    <div class="text-center text-gray-500 py-8">Carregando transações...</div>
</div>

<!-- Receipt Modal -->
<div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
        <!-- Header -->
        <div class="bg-gray-50 p-6 border-b border-gray-100 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-900">Comprovante de Transação</h3>
            <button onclick="closeReceipt()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Content -->
        <div class="p-6 space-y-6">
            <!-- Value and Status -->
            <div class="text-center">
                <p class="text-sm text-gray-500 mb-1">Valor da Transação</p>
                <h2 class="text-3xl font-bold text-gray-900" id="receipt-value">R$ 0,00</h2>
                <div id="receipt-status" class="mt-2 inline-block"></div>
            </div>

            <!-- Details Grid -->
            <div class="space-y-4 text-sm">
                <div class="flex justify-between py-2 border-b border-gray-50">
                    <span class="text-gray-500">Data e Hora</span>
                    <span class="font-medium text-gray-900 text-right" id="receipt-date">--/--/----</span>
                </div>

                <!-- Sender -->
                <div class="py-2 border-b border-gray-50">
                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Origem</p>
                    <p class="font-bold text-gray-900" id="receipt-sender-name">Nome do Remetente</p>
                    <p class="text-gray-500" id="receipt-sender-doc">***.***.***-**</p>
                </div>

                <!-- Receiver -->
                <div class="py-2 border-b border-gray-50">
                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Destino</p>
                    <p class="font-bold text-gray-900" id="receipt-receiver-name">Nome do Destinatário</p>
                    <p class="text-gray-500" id="receipt-receiver-doc">***.***.***-**</p>
                </div>

                <div class="flex justify-between py-2 border-b border-gray-50">
                    <span class="text-gray-500">Descrição</span>
                    <span class="font-medium text-gray-900 text-right" id="receipt-desc">-</span>
                </div>

                <div class="pt-2">
                    <p class="text-xs text-gray-400 mb-1">ID da Transação</p>
                    <p class="font-mono text-xs text-gray-500 break-all" id="receipt-id">UUID</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 p-4 flex gap-3">
            <button onclick="window.print()"
                class="flex-1 bg-white border border-gray-200 text-gray-700 font-medium py-2.5 rounded-xl hover:bg-gray-50 transition-colors flex justify-center items-center gap-2">
                <i data-lucide="printer" class="w-4 h-4"></i> Imprimir
            </button>
            <button onclick="closeReceipt()"
                class="flex-1 bg-purple-600 text-white font-medium py-2.5 rounded-xl hover:bg-purple-700 transition-colors">
                Fechar
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let allTransactions = [];

    async function loadExtrato() {
        try {
            const response = await fetch('/pix/extrato?limite=100');
            const data = await response.json();

            // Update Summary
            document.getElementById('saldo-atual').innerText = formatCurrency(data.balance);

            // Calculate totals locally for simplicity (or backend could provide)
            let entradas = 0;
            let saidas = 0;

            allTransactions = data.transactions;

            allTransactions.forEach(t => {
                if (t.type === 'RECEIVED' && t.status === 'CONFIRMED') entradas += t.value;
                if (t.type === 'SENT' && t.status === 'CONFIRMED') saidas += t.value;
            });

            document.getElementById('total-entradas').innerText = formatCurrency(entradas);
            document.getElementById('total-saidas').innerText = formatCurrency(saidas);

            renderTable(allTransactions);

        } catch (error) {
            console.error('Erro ao carregar extrato:', error);
            document.getElementById('extrato-body').innerHTML = `
                <tr><td colspan="4" class="p-8 text-center text-red-500">Erro ao carregar dados.</td></tr>
            `;
        }
    }

    function renderTable(transactions) {
        const tbody = document.getElementById('extrato-body');
        const mobileContainer = document.getElementById('extrato-mobile');

        tbody.innerHTML = '';
        mobileContainer.innerHTML = '';

        if (transactions.length === 0) {
            const emptyMsg = `<div class="p-8 text-center text-gray-500">Nenhuma transação encontrada.</div>`;
            tbody.innerHTML = `<tr><td colspan="4">${emptyMsg}</td></tr>`;
            mobileContainer.innerHTML = emptyMsg;
            return;
        }

        transactions.forEach(t => {
            // 1. Determine Counterparty Name (The "Title")
            let counterpartyName = 'Desconhecido';
            if (t.type === 'SENT') {
                counterpartyName = t.receiver_name || 'Destinatário Desconhecido';
            } else {
                counterpartyName = t.sender_name || 'Remetente Desconhecido';
            }

            // 2. Determine Transaction Type (The "Type")
            let transactionType = 'Transferência Pix';
            if (t.description && t.description.toLowerCase().includes('boleto')) {
                transactionType = 'Pagamento de Boleto';
            } else if (t.description && t.description.toLowerCase().includes('depósito')) {
                transactionType = 'Depósito';
            } else if (t.type === 'RECEIVED' && t.pix_key === 'SIMULACAO_QR_CODE') {
                transactionType = 'Depósito via QR Code';
            }

            // 3. Format Time (Brasília Time)
            let timeDisplay = '';
            let fullDateDisplay = '';

            if (t.formatted_time) {
                // Backend sends "DD/MM/YYYY às HH:mm:ss"
                const parts = t.formatted_time.split(' às ');
                if (parts.length === 2) {
                    const timeShort = parts[1].substring(0, 5); // HH:mm
                    const dateShort = parts[0].substring(0, 5); // DD/MM
                    timeDisplay = `${timeShort}`;
                    fullDateDisplay = `${parts[0]} ${timeShort}`;
                } else {
                    timeDisplay = t.formatted_time;
                    fullDateDisplay = t.formatted_time;
                }
            } else {
                const d = new Date(t.created_at || t.created_at);
                timeDisplay = d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                fullDateDisplay = d.toLocaleDateString('pt-BR') + ' ' + timeDisplay;
            }

            // Nubank Style Subtitle: "HH:mm - Tipo"
            const subtitleText = `${timeDisplay} - ${transactionType}`;

            const isNegative = t.type === 'SENT';
            const colorClass = isNegative ? 'text-gray-900' : 'text-green-600'; // Nubank uses black for sent, green for received usually, or just black/gray. Let's stick to user request or standard. User asked for "ícone de enviado".
            // Actually Nubank uses black for value usually, but let's keep green/red for clarity or adapt.
            // User didn't specify value color, but "ícone de enviado".

            const sign = isNegative ? '-' : ''; // Nubank often doesn't show + for incoming, just value.

            // Icons
            const icon = isNegative ? 'arrow-up-right' : 'arrow-down-left';
            const iconBg = isNegative ? 'bg-gray-100 text-gray-900' : 'bg-green-100 text-green-700'; // Nubank style is subtle

            let statusBadge = '';
            let actions = '';

            if (t.status === 'CONFIRMED') {
                // Nubank doesn't show "Confirmado" badge in the list usually, just the item.
                // But we'll keep a small indicator or just hide it for confirmed to be cleaner.
                // Let's keep it minimal.
                statusBadge = '';
            }
            else if (t.status === 'SCHEDULED') {
                statusBadge = '<span class="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-xs font-medium">Agendado</span>';
                actions = `
                    <button onclick="cancelarAgendamento('${t.id}')" class="p-1 text-red-500 hover:bg-red-50 rounded transition-colors" title="Cancelar">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
            }
            else if (t.status === 'FAILED') statusBadge = '<span class="px-2 py-0.5 bg-red-50 text-red-600 rounded text-xs font-medium">Falha</span>';
            else if (t.status === 'CANCELED') statusBadge = '<span class="px-2 py-0.5 bg-gray-100 text-gray-500 rounded text-xs font-medium line-through">Cancelado</span>';
            else statusBadge = `<span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs font-medium">${t.status}</span>`;

            // Add Receipt Button (Subtle)
            const receiptBtn = `
                <button onclick="openReceipt('${t.id}')" class="p-1 text-gray-400 hover:text-purple-600 transition-colors" title="Ver Comprovante">
                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                </button>
            `;
            // In Nubank list, clicking the item usually opens details. We'll use the button for now.

            // Desktop Row
            const row = `
                <tr class="hover:bg-gray-50 transition-colors group cursor-pointer" onclick="openReceipt('${t.id}')">
                    <td class="p-4 text-sm text-gray-500">
                        ${fullDateDisplay}
                    </td>
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-full ${iconBg}">
                                <i data-lucide="${icon}" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-gray-900">${counterpartyName}</p>
                                <p class="text-xs text-gray-500">${transactionType}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">
                        ${statusBadge}
                    </td>
                    <td class="p-4 text-sm font-bold text-right ${t.type === 'SENT' ? 'text-gray-900' : 'text-green-600'}">
                        ${sign} ${formatCurrency(t.value)}
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;

            // Mobile Card (Nubank Style)
            const card = `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-start cursor-pointer hover:bg-gray-50 transition-colors" onclick="openReceipt('${t.id}')">
                    <div class="flex items-start gap-4">
                        <div class="p-3 rounded-full ${iconBg} mt-1">
                            <i data-lucide="${icon}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h4 class="text-base font-bold text-gray-900 leading-tight mb-1">
                                ${counterpartyName}
                            </h4>
                            <p class="text-sm text-gray-500 font-medium">
                                ${subtitleText}
                            </p>
                            ${statusBadge ? `<div class="mt-1">${statusBadge}</div>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-base font-bold ${t.type === 'SENT' ? 'text-gray-900' : 'text-green-600'}">
                            ${sign} ${formatCurrency(t.value)}
                        </p>
                        ${actions ? `<div class="mt-2 flex justify-end" onclick="event.stopPropagation()">${actions}</div>` : ''}
                    </div>
                </div>
            `;
            mobileContainer.innerHTML += card;
        });        // Re-initialize icons for new elements
        if (window.lucide) {
            lucide.createIcons();
        }
    }

    async function cancelarAgendamento(id) {
        if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return;

        try {
            const response = await fetch(`/pix/transacoes/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Agendamento cancelado com sucesso!');
                loadExtrato(); // Reload list
            } else {
                const err = await response.json();
                alert('Erro ao cancelar: ' + (err.detail || 'Erro desconhecido'));
            }
        } catch (error) {
            alert('Erro de conexão ao tentar cancelar.');
        }
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    }

    function filterExtrato(status) {
        if (status === 'todos') {
            renderTable(allTransactions);
        } else {
            const filtered = allTransactions.filter(t => t.status === status);
            renderTable(filtered);
        }
    }

    function openReceipt(id) {
        const t = allTransactions.find(tx => tx.id === id);
        if (!t) return;

        document.getElementById('receipt-value').innerText = formatCurrency(t.value);
        document.getElementById('receipt-date').innerText = t.formatted_time || new Date(t.created_at).toLocaleString('pt-BR');
        document.getElementById('receipt-desc').innerText = t.description || '-';
        document.getElementById('receipt-id').innerText = t.id;

        // Sender
        document.getElementById('receipt-sender-name').innerText = t.sender_name || 'Desconhecido';
        document.getElementById('receipt-sender-doc').innerText = t.sender_doc || '***';

        // Receiver
        document.getElementById('receipt-receiver-name').innerText = t.receiver_name || 'Desconhecido';
        document.getElementById('receipt-receiver-doc').innerText = t.receiver_doc || '***';

        // Status Badge in Modal
        const statusEl = document.getElementById('receipt-status');
        if (t.status === 'CONFIRMED') statusEl.innerHTML = '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">Confirmado</span>';
        else if (t.status === 'SCHEDULED') statusEl.innerHTML = '<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">Agendado</span>';
        else statusEl.innerHTML = `<span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">${t.status}</span>`;

        // Show Modal
        const modal = document.getElementById('receipt-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeReceipt() {
        const modal = document.getElementById('receipt-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Load on start
    loadExtrato();
</script>
{% endblock %}
