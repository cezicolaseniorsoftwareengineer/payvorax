{% extends "base.html" %}

{% block content %}
<div class="mb-4">
    <h1 class="text-2xl font-bold text-gray-900">Simulação</h1>
    <p class="text-gray-500">Calcule parcelas com juros compostos.</p>
</div>

<div class="bg-white rounded-xl p-6 shadow-sm mb-6">
    <form id="simForm" class="space-y-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Valor da Compra</label>
            <div class="relative">
                <span class="absolute left-3 top-3 text-gray-500">R$</span>
                <input type="number" id="valor"
                    class="w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none text-lg font-semibold"
                    placeholder="1000,00">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Parcelas</label>
                <input type="number" id="parcelas" value="12"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Taxa Mensal (%)</label>
                <input type="number" id="taxa" value="3.5" step="0.1"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
            </div>
        </div>

        <button type="submit"
            class="w-full bg-gray-900 text-white font-bold py-4 rounded-full hover:bg-gray-800 transition-colors shadow-md">
            Calcular Parcelas
        </button>
    </form>
</div>

<!-- Results Area -->
<div id="results" class="hidden space-y-4">
    <div class="bg-purple-50 border border-purple-100 rounded-xl p-6 text-center">
        <p class="text-sm text-purple-800 mb-1">Valor da Parcela</p>
        <h2 class="text-3xl font-bold text-purple-900" id="valorParcela">R$ 0,00</h2>
        <p class="text-xs text-purple-600 mt-2">Total a pagar: <span id="totalPago" class="font-bold">R$ 0,00</span></p>
    </div>

    <div class="bg-white rounded-xl p-4 shadow-sm">
        <h3 class="font-semibold text-gray-800 mb-3">Detalhamento</h3>
        <div class="space-y-2 text-sm">
            <div class="flex justify-between border-b border-gray-100 pb-2">
                <span class="text-gray-500">CET Anual</span>
                <span class="font-medium text-gray-900" id="cetAnual">0%</span>
            </div>
            <div class="flex justify-between border-b border-gray-100 pb-2">
                <span class="text-gray-500">Juros Totais</span>
                <span class="font-medium text-red-500" id="jurosTotais">R$ 0,00</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('simForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            value: parseFloat(document.getElementById('valor').value),
            installments: parseInt(document.getElementById('parcelas').value),
            monthly_rate: parseFloat(document.getElementById('taxa').value) / 100
        };

        try {
            const response = await fetch('/parcelamento/simulate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                document.getElementById('results').classList.remove('hidden');

                // Format currency
                const fmt = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

                document.getElementById('valorParcela').innerText = fmt(result.installment);
                document.getElementById('totalPago').innerText = fmt(result.total_paid);
                document.getElementById('cetAnual').innerText = result.annual_cet + '%';
                document.getElementById('jurosTotais').innerText = fmt(result.total_paid - data.value);
            }
        } catch (error) {
            alert('Erro ao calcular');
        }
    });
</script>
{% endblock %}
